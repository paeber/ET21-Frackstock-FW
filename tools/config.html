<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
        <script>
            if (!('serial' in navigator)) {
                alert('Web Serial API not supported.');
            }
        </script>
        <title>Frackstock Configurator</title>
    </head>
    <body>
        <style>
            #message {
                background-color: black;
                color: white;
                font-family: 'Courier New', monospace;
                height: 400px;
                overflow: auto;
                white-space: pre-wrap;
                padding: 10px;
            }

        </style>

        <div class="container">
            <div class="row mb-3">
                <div class="col">
                    <h1>Frackstock Configurator</h1>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row mb-3">
                <div class="col">
                    <button id="connect" class="btn btn-primary">Verbinden</button>
                    <button id="apply" class="btn btn-primary" disabled>Apply</button>
                    <button id="reset" class="btn btn-danger" disabled>Reset</button>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title">Device Info</h5>
                        <button id="getStatus" class="btn btn-primary" disabled>Refresh</button>
                    </div>
                    <div id="deviceInfo"></div>
                </div>
            </div>
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title">Color</h5>
                        <button id="setColor" class="btn btn-primary ml-2" disabled>Set</button>
                    </div>
                    
                    Red:<input type="number" id="red" min="0" max="255" value="0" class="ml-2">
                    Green:<input type="number" id="green" min="0" max="255" value="255" class="ml-2">
                    Blue:<input type="number" id="blue" min="0" max="255" value="0" class="ml-2">
                </div>
            </div>
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title">Abreviation</h5>
                        <button id="setAbrev" class="btn btn-primary ml-2" disabled>Set</button>
                    </div>
                    Max 8 characters
                    <input type="text" id="abrev" class="ml-2">
                </div>
            </div>

            <div class="row mb-3">
                <div class="col">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title">Terminal</h5>
                    </div>
                    <div id="message" class="alert alert-info"></div>
                </div>
            </div>
        </div>

    <script>
        let port;
        let reader;
        let encoder = new TextEncoder('utf-8');
        let lines = [];

        function appendMessage(text) {
            let messageBox = document.getElementById('message');
            let timestamp = new Date().toLocaleTimeString();
            messageBox.innerHTML += `[${timestamp}]: ${text}`;
        }

        async function sendMessage(message) {
            let data = encoder.encode(message + "\n");
            const writer = port.writable.getWriter();
            await writer.write(data);
            writer.releaseLock();
        }

        async function readLoop() {
            let response = '';
            while (true) {
                const { value, done } = await reader.read();
                if (done) {
                    // The port has been closed or there was an error.
                    break;
                } else {
                    let decoder = new TextDecoder('utf-8');
                    let chunk = decoder.decode(value);
                    if (chunk.includes('\n')) {
                        let parts = chunk.split('\n');
                        lines.push(response + parts[0]);
                        response = parts[1];
                        for (let line of lines) {
                            processStatus(line);
                        }
                        lines = [];
                    } else {
                        response += chunk;
                    }

                }
            }
        }

        function processStatus(status) {
            // This function will be called whenever a status message is received
            // TODO: Implement your status processing here
            console.log(status);
            appendMessage(status);

            // Check if the status message is a valid JSON object
            try {
                let statusObj = JSON.parse(status);
                // Zeigen Sie die analysierten Daten in der deviceInfo div an
                document.getElementById('deviceInfo').innerHTML = `
                    <table>
                        <tr><td>Version:</td><td>${statusObj.v}</td></tr>
                        <tr><td>ID:</td><td>${statusObj.id}</td></tr>
                        <tr><td>Beer:</td><td>${statusObj.beer}</td></tr>
                        <tr><td>Color:</td><td>${statusObj.color}</td></tr>
                        <tr><td>Abreviation:</td><td>${statusObj.abrev}</td></tr>
                    </table>
                `;
            } catch (e) {
                // The status message is not a valid JSON object
            }
        }

        async function startReading() {
            reader = port.readable.getReader();
            await readLoop();
        }

        document.getElementById('connect').addEventListener('click', async () => {
            port = await navigator.serial.requestPort();
            await port.open({ baudRate: 115200 });

            document.getElementById('setColor').disabled = false;
            document.getElementById('setAbrev').disabled = false;
            document.getElementById('apply').disabled = false;
            document.getElementById('reset').disabled = false;
            document.getElementById('getStatus').disabled = false;

            startReading();
        });

        document.getElementById('setColor').addEventListener('click', async () => {
            let red = document.getElementById('red').value;
            let green = document.getElementById('green').value;
            let blue = document.getElementById('blue').value;
            sendMessage(`set color (${red},${green},${blue})`);
        });

        document.getElementById('setAbrev').addEventListener('click', async () => {
            let abrev = document.getElementById('abrev').value;
            sendMessage(`set abrev ${abrev}`);
        });

        document.getElementById('reset').addEventListener('click', async () => {
            sendMessage('reset');
            
            document.getElementById('setColor').disabled = true;
            document.getElementById('setAbrev').disabled = true;
            document.getElementById('apply').disabled = true;
            document.getElementById('reset').disabled = true;
            document.getElementById('getStatus').disabled = true;
        });

        document.getElementById('apply').addEventListener('click', async () => {
            sendMessage('apply');
        });

        document.getElementById('getStatus').addEventListener('click', async () => {
            await sendMessage('status');
        });

    </script>
</body>
</html>